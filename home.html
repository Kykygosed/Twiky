<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twiky - Fil</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1em;
      background-color: #1da1f2;
      color: white;
      font-weight: bold;
    }
    .search-bar {
      flex-grow: 1;
      margin: 0 1em;
    }
    .search-bar input {
      width: 100%;
      padding: 0.5em;
      border-radius: 5px;
      border: none;
    }
    .main {
      display: flex;
      justify-content: center;
      padding: 1em;
    }
    .feed {
      width: 600px;
    }
    .new-post {
      background: white;
      padding: 1em;
      border-radius: 10px;
      margin-bottom: 1em;
    }
    .new-post textarea {
      width: 100%;
      height: 80px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0.5em;
      resize: none;
    }
    .new-post button {
      margin-top: 0.5em;
      padding: 0.5em 1em;
      background-color: #1da1f2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .post {
      background: white;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 10px;
    }
    .post .meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: gray;
    }
    .post .actions button {
      margin-right: 10px;
    }
    .comment-section {
      margin-top: 0.5em;
    }
    .sidebar {
      width: 300px;
      margin-left: 1em;
    }
    .sidebar .box {
      background: white;
      padding: 1em;
      border-radius: 10px;
      margin-bottom: 1em;
    }
    .chatbox {
      background: white;
      padding: 1em;
      border-radius: 10px;
      height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .chat-input {
      display: flex;
      margin-top: 0.5em;
    }
    .chat-input input {
      flex: 1;
      padding: 0.5em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .chat-input button {
      margin-left: 0.5em;
      padding: 0.5em;
      border-radius: 5px;
      border: none;
      background: #1da1f2;
      color: white;
    }
    #notif-popup {
      position: absolute;
      top: 60px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 1em;
      display: none;
      z-index: 999;
    }
    #notif-popup ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #notif-popup li {
      margin-bottom: 0.5em;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div id="username-display">@pseudo</div>
    <div class="search-bar">
      <input type="text" placeholder="Rechercher...">
    </div>
    <div>
      <button onclick="logout()">D√©connexion</button>
      <button id="notif-btn" onclick="toggleNotifications()">üîî <span id="notif-count">0</span></button>
    </div>
  </div>

  <div id="notif-popup"><ul id="notif-list"></ul></div>

  <div class="main">
    <div class="feed">
      <div class="new-post">
        <textarea id="post-content" placeholder="Quoi de neuf ?"></textarea>
        <button onclick="sendPost()">‚úâÔ∏è Envoyer</button>
      </div>
      <div id="posts-list"></div>
    </div>

    <div class="sidebar">
      <div class="box">
        <h3>üî• Top 5 Posts</h3>
        <ul id="top-posts"></ul>
      </div>
      <div class="box">
        <h3>üí¨ Top 5 Posteurs</h3>
        <ul id="top-users"></ul>
      </div>
      <div class="box">
        <h3>üí¨ Chat en direct</h3>
        <div class="chatbox" id="chat-box"></div>
        <div class="chat-input">
          <input type="text" id="chat-msg" placeholder="Message...">
          <button onclick="sendChat()">Envoyer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCItTa7T4vROhWFHfrbNnVD8RoCBuZKaXM",
      authDomain: "twiky-2e73a.firebaseapp.com",
      databaseURL: "https://twiky-2e73a-default-rtdb.firebaseio.com",
      projectId: "twiky-2e73a",
      storageBucket: "twiky-2e73a.firebasestorage.app",
      messagingSenderId: "850733637403",
      appId: "1:850733637403:web:0b8b4ffea9878765643dbe",
      measurementId: "G-XQYWKVJZXF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const uid = localStorage.getItem('uid');
    if (!uid) window.location.href = 'index.html';

    let currentUser = "Utilisateur";
    firebase.database().ref('users/' + uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      currentUser = userData?.username || 'Utilisateur';
      document.getElementById('username-display').textContent = '@' + currentUser;
      firebase.database().ref('users/' + uid + '/lastSeen').set(new Date().toISOString());
    });

    function logout() {
      firebase.database().ref('users/' + uid).update({ online: false });
      auth.signOut().then(() => {
        localStorage.removeItem('uid');
        window.location.href = 'index.html';
      });
    }

    function sendPost() {
      const content = document.getElementById('post-content').value.trim();
      if (!content) return;
      const postData = {
        author: currentUser,
        content: content,
        date: new Date().toISOString(),
        likes: 0,
        dislikes: 0,
        comments: {},
        seenBy: { [uid]: true }
      };
      const newPostRef = db.ref('posts').push();
      newPostRef.set(postData);
      document.getElementById('post-content').value = '';
    }

    function displayPost(key, data) {
      const div = document.createElement('div');
      div.className = 'post';
      div.innerHTML = `
        <div class="meta"><span>@${data.author}</span><span>${new Date(data.date).toLocaleString()}</span></div>
        <div class="content">${data.content}</div>
        <div class="actions">
          <button onclick="likePost('${key}')">‚ù§Ô∏è ${data.likes || 0}</button>
          <button onclick="dislikePost('${key}')">üëé ${data.dislikes || 0}</button>
        </div>
        <div class="comment-section">
          <input placeholder="Ajouter un commentaire..." id="comment-${key}" />
          <button onclick="sendComment('${key}')">üí¨</button>
          <div id="comments-${key}"></div>
        </div>
      `;
      document.getElementById('posts-list').prepend(div);
      if (!data.seenBy || !data.seenBy[uid]) {
        addNotification(key, data);
        db.ref('posts/' + key + '/seenBy/' + uid).set(true);
      }
      if (data.comments) {
        for (const commentKey in data.comments) {
          const comment = data.comments[commentKey];
          const c = document.createElement('div');
          c.textContent = `@${comment.user}: ${comment.text}`;
          document.getElementById(`comments-${key}`).appendChild(c);
        }
      }
    }

    function likePost(postId) {
      const ref = db.ref('posts/' + postId + '/likes');
      ref.transaction(val => (val || 0) + 1);
    }

    function dislikePost(postId) {
      const ref = db.ref('posts/' + postId + '/dislikes');
      ref.transaction(val => (val || 0) + 1);
    }

    function sendComment(postId) {
      const input = document.getElementById(`comment-${postId}`);
      const comment = input.value.trim();
      if (!comment) return;
      db.ref('posts/' + postId + '/comments').push({ user: currentUser, text: comment });
      input.value = '';
    }

    db.ref('posts').on('child_added', snapshot => {
      displayPost(snapshot.key, snapshot.val());
    });

    db.ref('chat').on('child_added', snapshot => {
      const data = snapshot.val();
      const msgDiv = document.createElement('div');
      msgDiv.textContent = `[${new Date(data.date).toLocaleTimeString()}] @${data.user}: ${data.message}`;
      document.getElementById('chat-box').appendChild(msgDiv);
      document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
    });

    function sendChat() {
      const msg = document.getElementById('chat-msg').value.trim();
      if (!msg) return;
      db.ref('chat').push({ user: currentUser, message: msg, date: new Date().toISOString() });
      document.getElementById('chat-msg').value = '';
    }

    function toggleNotifications() {
      const box = document.getElementById('notif-popup');
      box.style.display = box.style.display === 'block' ? 'none' : 'block';
      document.getElementById('notif-count').textContent = '0';
    }

    function addNotification(key, data) {
      const notifList = document.getElementById('notif-list');
      const li = document.createElement('li');
      li.innerHTML = `<strong>@${data.author}</strong>: ${data.content.substring(0, 50)}...`;
      notifList.prepend(li);
      const count = document.getElementById('notif-count');
      count.textContent = parseInt(count.textContent) + 1;
    }
  </script>
</body>
</html>
