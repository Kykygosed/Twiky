<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twiky - Fil</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1em;
      background-color: #1da1f2;
      color: white;
      font-weight: bold;
    }
    .search-bar {
      flex-grow: 1;
      margin: 0 1em;
    }
    .search-bar input {
      width: 100%;
      padding: 0.5em;
      border-radius: 5px;
      border: none;
    }
    .main {
      display: flex;
      justify-content: center;
      padding: 1em;
    }
    .feed {
      width: 600px;
    }
    .new-post {
      background: white;
      padding: 1em;
      border-radius: 10px;
      margin-bottom: 1em;
    }
    .new-post textarea {
      width: 100%;
      height: 80px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0.5em;
      resize: none;
    }
    .new-post button {
      margin-top: 0.5em;
      padding: 0.5em 1em;
      background-color: #1da1f2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .post {
      background: white;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 10px;
    }
    .post .meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: gray;
    }
    .post .actions button {
      margin-right: 10px;
      padding: 0.3em 0.6em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #e1e8ed;
    }
    .post .actions button:hover {
      background-color: #d5dadd;
    }
    .comment-section {
      margin-top: 0.5em;
    }
    .sidebar {
      width: 300px;
      margin-left: 1em;
    }
    .sidebar .box {
      background: white;
      padding: 1em;
      border-radius: 10px;
      margin-bottom: 1em;
    }
    .chatbox {
      background: white;
      padding: 1em;
      border-radius: 10px;
      height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .chat-input {
      display: flex;
      margin-top: 0.5em;
    }
    .chat-input input {
      flex: 1;
      padding: 0.5em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .chat-input button {
      margin-left: 0.5em;
      padding: 0.5em;
      border-radius: 5px;
      border: none;
      background: #1da1f2;
      color: white;
    }
    #notif-popup {
      position: absolute;
      top: 60px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 1em;
      display: none;
      z-index: 999;
    }
    #notif-popup ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #notif-popup li {
      margin-bottom: 0.5em;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5em;
    }
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 5px;
    }
    .online { background: green; }
    .offline { background: red; }
  </style>
</head>
<body>
<div class="topbar">
  <div id="user-info">
    <span id="username-display">Utilisateur</span>
    <span class="status-dot offline" id="status-dot"></span>
    <button onclick="logout()">Se d√©connecter</button>
  </div>
  <div class="search-bar">
    <input type="text" placeholder="Rechercher un post ou un utilisateur...">
  </div>
  <div>
    <button onclick="toggleNotifications()">
      üîî <span id="notif-count" style="background:red;color:white;border-radius:50%;padding:0 5px;">0</span>
    </button>
  </div>
</div>

<div id="notif-popup">
  <ul id="notif-list"></ul>
</div>

<div class="main">
  <div class="feed">
    <div class="new-post">
      <textarea id="postContent" placeholder="Exprime-toi..."></textarea>
      <div id="retweet-preview" style="margin: 0.5em 0;"></div>
      <button onclick="createPost()">üì® Publier</button>
    </div>
    <div id="posts-list"></div>
  </div>

  <div class="sidebar">
    <div class="box">
      <h3>Top 5 Posts ‚ù§Ô∏è</h3>
      <ul id="top-posts"></ul>
    </div>
    <div class="box">
      <h3>Top 5 Posteurs üß†</h3>
      <ul id="top-users"></ul>
    </div>
    <div class="box">
      <h3>Chat des connect√©s üí¨</h3>
      <div class="chatbox" id="chatbox"></div>
      <div class="chat-input">
        <input type="text" id="chatMessage" placeholder="√âcris un message...">
        <button onclick="sendChat()">Envoyer</button>
      </div>
    </div>
  </div>
</div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, push, onChildAdded, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCItTa7T4vROhWFHfrbNnVD8RoCBuZKaXM",
    authDomain: "twiky-2e73a.firebaseapp.com",
    databaseURL: "https://twiky-2e73a-default-rtdb.firebaseio.com",
    projectId: "twiky-2e73a",
    storageBucket: "twiky-2e73a.firebasestorage.app",
    messagingSenderId: "850733637403",
    appId: "1:850733637403:web:0b8b4ffea9878765643dbe",
    measurementId: "G-XQYWKVJZXF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  let currentUser = null;
  let unreadPosts = [];

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("username-display").innerText = user.displayName || user.email;
      updatePresence(user.uid, true);
      setupListeners();
    } else {
      window.location.href = "index.html";
    }
  });

  window.logout = () => {
    if (currentUser) updatePresence(currentUser.uid, false);
    signOut(auth);
  };

  function updatePresence(uid, online) {
    const userRef = ref(db, 'presence/' + uid);
    set(userRef, { online, lastSeen: Date.now() });
  }

  function setupListeners() {
    listenPosts();
    listenChat();
    listenPresence();
    listenTopStats();
  }

  function createPost() {
    const content = document.getElementById("postContent").value.trim();
    if (!content) return;
    const postsRef = ref(db, "posts");
    const newPostRef = push(postsRef);
    set(newPostRef, {
      author: currentUser.displayName || currentUser.email,
      uid: currentUser.uid,
      content,
      timestamp: Date.now(),
      likes: {},
      dislikes: {},
      comments: {},
      retweetOf: retweetTargetId || null
    });
    document.getElementById("postContent").value = "";
    document.getElementById("retweet-preview").innerHTML = "";
    retweetTargetId = null;
  }

  let retweetTargetId = null;

  function listenPosts() {
    const postsRef = ref(db, "posts");
    onChildAdded(postsRef, (snapshot) => {
      const data = snapshot.val();
      const key = snapshot.key;
      unreadPosts.push({ key, data });
      renderNotificationCount();
      renderPost(data, key);
    });
  }

  function renderPost(data, key) {
    const postContainer = document.getElementById("posts-list");
    const postDiv = document.createElement("div");
    postDiv.className = "post";
    postDiv.id = `post-${key}`;

    const isLiked = data.likes && data.likes[currentUser.uid];
    const isDisliked = data.dislikes && data.dislikes[currentUser.uid];
    const likeCount = data.likes ? Object.keys(data.likes).length : 0;
    const dislikeCount = data.dislikes ? Object.keys(data.dislikes).length : 0;

    const onlineStatus = onlineUsers[data.uid] ? "online" : "offline";

    postDiv.innerHTML = `
      <div class="meta">
        <span>${data.author} <span class="status-dot ${onlineStatus}"></span></span>
        <span>${new Date(data.timestamp).toLocaleString()}</span>
      </div>
      <div>${data.content}</div>
      ${data.retweetOf ? `<div class="retweet-preview">‚Ü©Ô∏è Retweet d'un post <button onclick="gotoOriginal('${data.retweetOf}')">Voir</button></div>` : ""}
      <div class="actions">
        <button onclick="likePost('${key}')" ${isLiked ? "disabled" : ""}>‚ù§Ô∏è ${likeCount}</button>
        <button onclick="dislikePost('${key}')" ${isDisliked ? "disabled" : ""}>üëé ${dislikeCount}</button>
        <button onclick="retweet('${key}', \`${data.content.replace(/`/g, "\\`")}\`)">‚Ü©Ô∏è Retweeter</button>
      </div>
      <div class="comment-section">
        <input type="text" placeholder="Commenter..." onkeypress="if(event.key==='Enter')commentPost('${key}', this)">
        <div id="comments-${key}"></div>
      </div>
    `;
    postContainer.prepend(postDiv);
    renderComments(data.comments, key);
  }

  function likePost(postId) {
    const likeRef = ref(db, `posts/${postId}/likes/${currentUser.uid}`);
    set(likeRef, true);
    const dislikeRef = ref(db, `posts/${postId}/dislikes/${currentUser.uid}`);
    set(dislikeRef, null);
  }

  function dislikePost(postId) {
    const dislikeRef = ref(db, `posts/${postId}/dislikes/${currentUser.uid}`);
    set(dislikeRef, true);
    const likeRef = ref(db, `posts/${postId}/likes/${currentUser.uid}`);
    set(likeRef, null);
  }

  function commentPost(postId, input) {
    const comment = input.value.trim();
    if (!comment) return;
    const commentRef = push(ref(db, `posts/${postId}/comments`));
    set(commentRef, {
      author: currentUser.displayName || currentUser.email,
      content: comment,
      timestamp: Date.now()
    });
    input.value = "";
  }

  function renderComments(comments, postId) {
    const container = document.getElementById(`comments-${postId}`);
    container.innerHTML = "";
    if (!comments) return;
    Object.values(comments).forEach(c => {
      const div = document.createElement("div");
      div.innerText = `${c.author}: ${c.content}`;
      container.appendChild(div);
    });
  }

  function retweet(postId, content) {
    retweetTargetId = postId;
    document.getElementById("retweet-preview").innerHTML = `<div style="border-left:3px solid #1da1f2;padding-left:5px;">‚Ü©Ô∏è ${content}</div>`;
  }

  function gotoOriginal(postId) {
    const el = document.getElementById(`post-${postId}`);
    if (el) el.scrollIntoView({ behavior: "smooth" });
  }

  function toggleNotifications() {
    const box = document.getElementById("notif-popup");
    box.style.display = box.style.display === "block" ? "none" : "block";
    const list = document.getElementById("notif-list");
    list.innerHTML = "";
    unreadPosts.forEach(({ key, data }) => {
      const li = document.createElement("li");
      li.innerText = `${data.author}: ${data.content}`;
      li.onclick = () => gotoOriginal(key);
      list.appendChild(li);
    });
    unreadPosts = [];
    renderNotificationCount();
  }

  function renderNotificationCount() {
    document.getElementById("notif-count").innerText = unreadPosts.length;
  }

  function listenChat() {
    const chatRef = ref(db, "chat");
    onChildAdded(chatRef, snap => {
      const msg = snap.val();
      const div = document.createElement("div");
      const status = onlineUsers[msg.uid] ? "online" : "offline";
      div.innerHTML = `<b>${msg.author}</b> <span class="status-dot ${status}"></span>: ${msg.content}`;
      document.getElementById("chatbox").appendChild(div);
    });
  }

  function sendChat() {
    const msg = document.getElementById("chatMessage").value.trim();
    if (!msg) return;
    const msgRef = push(ref(db, "chat"));
    set(msgRef, {
      author: currentUser.displayName || currentUser.email,
      uid: currentUser.uid,
      content: msg,
      timestamp: Date.now()
    });
    document.getElementById("chatMessage").value = "";
  }

  let onlineUsers = {};

  function listenPresence() {
    const presenceRef = ref(db, "presence");
    onValue(presenceRef, (snapshot) => {
      onlineUsers = {};
      snapshot.forEach(child => {
        const data = child.val();
        if (data.online) onlineUsers[child.key] = true;
      });
      refreshOnlineStatus();
    });
  }

  function refreshOnlineStatus() {
    document.querySelectorAll(".status-dot").forEach(dot => {
      dot.classList.remove("online", "offline");
      const uid = dot.dataset.uid;
      dot.classList.add(onlineUsers[uid] ? "online" : "offline");
    });
  }

  function listenTopStats() {
    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      const posts = [];
      const userCounts = {};
      snapshot.forEach(child => {
        const data = child.val();
        data.key = child.key;
        posts.push(data);
        if (!userCounts[data.author]) userCounts[data.author] = 0;
        userCounts[data.author]++;
      });

      const topPosts = posts.sort((a, b) => {
        const aLikes = a.likes ? Object.keys(a.likes).length : 0;
        const bLikes = b.likes ? Object.keys(b.likes).length : 0;
        return bLikes - aLikes;
      }).slice(0, 5);

      document.getElementById("top-posts").innerHTML = topPosts.map(p => `<li>${p.author}: ${p.content.slice(0, 30)}...</li>`).join("");

      const topUsers = Object.entries(userCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, count]) => `<li>${name} (${count})</li>`);

      document.getElementById("top-users").innerHTML = topUsers.join("");
    });
  }
</script>
